/*
FUNÇÃO CRIADA CONSIDERANDO UMA TABELA DE FERIADOS SIMPLES 
 E COM OS DADOS DE CARGA INICIAL A SEGUIR PARA TESTES

--DROP TABLE TFERIADO;
CREATE TABLE TFERIADO
(
	CODIGO    INTEGER     NOT NULL,
  DATA      DATETIME    NOT NULL,
	DESCRICAO VARCHAR(50) NOT NULL
);
ALTER TABLE TFERIADO ADD CONSTRAINT FERIADO_PK PRIMARY KEY(CODIGO);

INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(2, '2022-02-16' ,'CARNAVAL');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(3, '2022-04-02' ,'PAIXÃO DE CRISTO');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(4, '2022-04-21' ,'TIRADENTES');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(5, '2022-06-03' ,'CORPUS CHRISTI');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(6, '2022-09-07' ,'INDEPENDÊNCIA DO BRASIL');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(7, '2022-10-12' ,'NOSSA SENHORA APARECIDA');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(8, '2022-11-02' ,'FINADOS');
INSERT INTO TFERIADO(CODIGO, DATA, DESCRICAO) VALUES(9, '2022-12-25' ,'NATAL');

SELECT * FROM TFERIADO;
*/

--DROP FUNCTION FDIASUTEIS;
CREATE FUNCTION FDIASUTEIS(@DATAINI DATETIME,
                           @DATAFIN DATETIME) RETURNS INTEGER
BEGIN         
  DECLARE @DIAS INTEGER  = 0,
          @DT   DATETIME = @DATAINI;
  
  WHILE (@DT <= @DATAFIN) 
  BEGIN 
    IF (
        (DATEPART(WEEKDAY, @DT) NOT IN(7,1)) AND 
        (@DT NOT IN( SELECT data FROM TFERIADO))
       )
      SET @DIAS += 1;
    
    SET @DT = DATEADD(DAY, 1, @DT);
  END
  
  RETURN @DIAS;
END;
GO

/*
SELECT DBO.FDIASUTEIS(GETDATE(), GETDATE()+15);
SELECT DBO.FDIASUTEIS('2022-4-20', '2022-4-25');
*/
