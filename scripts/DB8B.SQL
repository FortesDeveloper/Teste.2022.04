BEGIN
  IF object_id('tempdb.dbo.##TEMP1') IS NOT NULL 
	  DROP TABLE ##TEMP1
  
  SELECT A.CODIGO_APARTAMENTO,
         C.NOME_CIDADE,
         SUM(P.VALOR_PAGAMENTO) AS SOMA
    INTO ##TEMP1
    FROM TABELA_APARTAMENTO A
    INNER JOIN TABELA_EDIFICIO E ON(E.CODIGO_EDIFICIO = A.CODIGO_EDIFICIO)
    INNER JOIN TABELA_CIDADE   C ON(C.CODIGO_CIDADE   = E.CODIGO_CIDADE)
    INNER JOIN TABELA_PAGAMENTOS_CONDOMINIO P ON(P.CODIGO_APARTAMENTO = A.CODIGO_APARTAMENTO)
  WHERE C.NOME_CIDADE = 'São Paulo'
  --WHERE C.NOME_CIDADE = 'Campinas'
  GROUP BY A.CODIGO_APARTAMENTO,
           C.NOME_CIDADE
  
  SELECT T.CODIGO_APARTAMENTO,
         T.NOME_CIDADE,
         T.SOMA
    FROM ##TEMP1 T
   WHERE T.SOMA = (SELECT MAX(SOMA) FROM ##TEMP1);
END;